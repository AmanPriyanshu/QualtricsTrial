<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Meta Tags and Title -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecureBank Data Sharing Consent</title>
    <!-- Unified CSS -->
    <style>
        /* General Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }

        body {
            background-color: #f5f5f5;
            color: #333;
            overflow-x: hidden;
        }

        /* Container */
        .container {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            min-height: 100vh;
            background-color: #fff;
            overflow-y: auto;
            padding-bottom: 50px;
            position: relative;
        }

        /* Hidden class for hiding pages */
        .hidden {
            display: none;
        }

        /* Header */
        header {
            background-color: #004080;
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .back-button {
            position: absolute;
            left: 20px;
            top: 20px;
            font-size: 24px;
            cursor: pointer;
        }

        /* Buttons */
        .btn {
            width: 90%;
            max-width: 400px;
            padding: 15px;
            margin: 20px auto;
            background: #004080;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            cursor: pointer;
            display: block;
            text-align: center;
        }

        .btn:hover {
            background: #003060;
        }

        /* Content Sections */
        .content-section {
            padding: 20px;
        }

        .content-section h2 {
            font-size: 24px;
            margin-bottom: 20px;
            text-align: center;
        }

        .content-section p {
            color: #555;
            margin-bottom: 15px;
            text-align: center;
            font-size: 16px;
        }

        /* Input Fields */
        .input-field {
            width: 90%;
            max-width: 400px;
            padding: 10px;
            margin: 10px auto;
            border: 1px solid #ccc;
            border-radius: 12px;
            font-size: 16px;
            display: block;
        }

        /* Option Buttons */
        .option-list {
            list-style: none;
            padding: 0;
            margin: 20px 0;
        }

        .option-item {
            background-color: #f9f9f9;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .option-item.active {
            border-color: #004080;
        }

        .option-item input[type="checkbox"] {
            margin-right: 15px;
        }

        .option-item .details {
            flex: 1;
        }

        .option-item .read-more {
            color: #004080;
            text-decoration: underline;
            cursor: pointer;
            font-size: 14px;
            margin-top: 5px;
        }

        /* Sub-options */
        .sub-options {
            margin-top: 10px;
            padding-left: 20px;
            display: none;
        }

        .sub-option-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .sub-option-item input[type="checkbox"] {
            margin-right: 10px;
        }

        /* Read More Sections */
        .read-more-content {
            display: none;
            margin-top: 10px;
            font-size: 14px;
            color: #555;
        }

        /* Footer */
        footer {
            background-color: #f0f0f0;
            padding: 15px;
            text-align: center;
            position: fixed;
            bottom: 0;
            width: 100%;
        }

        /* Progress Bar */
        .progress-bar {
            height: 6px;
            background-color: #e0e0e0;
            position: relative;
            margin: 10px 0;
        }

        .progress {
            background-color: #004080;
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }

        /* Confirmation Page */
        .confirmation {
            text-align: center;
            padding: 40px;
        }

        .confirmation .icon {
            font-size: 48px;
            color: #32a852;
            margin-bottom: 20px;
        }

        /* User Education */
        .education-section {
            padding: 20px;
        }

        .education-section h3 {
            font-size: 20px;
            margin-bottom: 15px;
        }

        .education-section p {
            margin-bottom: 10px;
            font-size: 16px;
            color: #555;
        }

        /* Feedback Form */
        .feedback-form textarea {
            width: 90%;
            max-width: 400px;
            padding: 10px;
            margin: 10px auto;
            border: 1px solid #ccc;
            border-radius: 12px;
            font-size: 16px;
            display: block;
            resize: vertical;
        }

        .feedback-form button {
            margin-top: 10px;
        }

        /* Progress Indicator */
        .progress-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 16px;
        }

        /* Legal Disclosures */
        .legal-section {
            max-height: 200px;
            overflow-y: auto;
            background-color: #f9f9f9;
            padding: 15px;
            margin: 15px 0;
            border-radius: 12px;
        }

        .legal-section p {
            font-size: 14px;
            color: #555;
            margin-bottom: 10px;
        }

        /* Disabled Option */
        .option-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Category Headers in Option List */
        .option-list h3 {
            font-size: 20px;
            margin-top: 20px;
            margin-bottom: 10px;
            color: #004080;
        }

        /* Show Sub-options */
        .option-item.active .sub-options {
            display: block;
        }

        /* Error Message */
        .error-message {
            color: red;
            text-align: center;
            margin-top: 10px;
            display: none;
        }
    </style>
</head>
<body>
    <!-- Container -->
    <div class="container">

        <!-- Page 1: Welcome and Introduction -->
        <div id="page1" class="content-section">
            <header>
                <h1>Welcome to SecureBank</h1>
                <div class="progress-indicator">Step 1 of 7</div>
            </header>
            <div class="progress-bar">
                <div class="progress" id="progressBar" style="width: 14%;"></div>
            </div>
            <main>
                <h2>Your Financial Journey Starts Here</h2>
                <p>At SecureBank, we prioritize your financial well-being. By securely sharing your financial data, you unlock personalized services tailored to your needs.</p>
                <p>Your privacy and control are our utmost priorities. Learn more about how we protect your data.</p>
                <button class="btn" onclick="showPage('page2')">Proceed</button>
            </main>
        </div>

        <!-- Page 2: Bank and Account Selection -->
        <div id="page2" class="content-section hidden">
            <header>
                <div class="back-button" onclick="showPage('page1')">&#8592;</div>
                <h1>Select Your Banks and Accounts</h1>
                <div class="progress-indicator">Step 2 of 7</div>
            </header>
            <div class="progress-bar">
                <div class="progress" id="progressBar" style="width: 28%;"></div>
            </div>
            <main>
                <p>Please select the banks where you hold accounts:</p>
                <ul class="option-list" id="bankList">
                    <!-- Bank options will be dynamically loaded here -->
                </ul>
                <p>You have full control over which accounts to share.</p>
                <button class="btn" onclick="proceedFromPage2()">Next</button>
            </main>
        </div>

        <!-- Page 3: Category and Function Selection -->
        <div id="page3" class="content-section hidden">
            <header>
                <div class="back-button" onclick="showPage('page2')">&#8592;</div>
                <h1>Select Data Categories and Functions</h1>
                <div class="progress-indicator">Step 3 of 7</div>
            </header>
            <div class="progress-bar">
                <div class="progress" id="progressBar" style="width: 42%;"></div>
            </div>
            <main>
                <p>Select the categories of data and the specific functions or inferences you consent to share. Click "Read More" for details.</p>
                <div id="categoryList">
                    <!-- Categories and functions will be dynamically loaded here -->
                </div>
                <div class="error-message" id="page3Error">Please select at least one function under each selected category.</div>
                <button class="btn" onclick="proceedFromPage3()">Next</button>
            </main>
        </div>

        <!-- Page 4: Time Frame Selection -->
        <div id="page4" class="content-section hidden">
            <header>
                <div class="back-button" onclick="showPage('page3')">&#8592;</div>
                <h1>Select Data Sharing Duration</h1>
                <div class="progress-indicator">Step 4 of 7</div>
            </header>
            <div class="progress-bar">
                <div class="progress" id="progressBar" style="width: 56%;"></div>
            </div>
            <main>
                <p>Choose how long you'd like to share your data. Click "Read More" for details on each option.</p>
                <ul class="option-list">
                    <li class="option-item" onclick="selectDuration(this, 'one-time')">
                        <input type="radio" name="duration" value="one-time"> <span class="details">One-Time Access</span>
                        <div class="read-more" onclick="toggleReadMore(this, event)">Read More</div>
                        <div class="read-more-content">Your data will be accessed once for immediate processing.</div>
                    </li>
                    <li class="option-item" onclick="selectDuration(this, 'monthly-6')">
                        <input type="radio" name="duration" value="monthly-6"> <span class="details">Monthly Access for 6 Months</span>
                        <div class="read-more" onclick="toggleReadMore(this, event)">Read More</div>
                        <div class="read-more-content">Your data will be accessed monthly over a period of six months to provide ongoing services.</div>
                    </li>
                    <li class="option-item" onclick="selectDuration(this, 'monthly-12')">
                        <input type="radio" name="duration" value="monthly-12"> <span class="details">Monthly Access for 12 Months</span>
                        <div class="read-more" onclick="toggleReadMore(this, event)">Read More</div>
                        <div class="read-more-content">Your data will be accessed monthly over a period of one year for continuous service improvement.</div>
                    </li>
                    <li class="option-item" onclick="toggleAdvancedDuration()">
                        <input type="radio" name="duration" value="custom"> <span class="details">Custom Duration</span>
                        <div class="read-more" onclick="toggleReadMore(this, event)">Read More</div>
                        <div class="read-more-content">Set a custom time frame that suits your preferences.</div>
                    </li>
                </ul>
                <div id="customDuration" class="hidden">
                    <p>Specify your custom time frame:</p>
                    <input type="date" class="input-field" id="startDate">
                    <input type="date" class="input-field" id="endDate">
                </div>
                <button class="btn" onclick="proceedFromPage4()">Next</button>
            </main>
        </div>

        <!-- Page 5: Review and Customize Consent -->
        <div id="page5" class="content-section hidden">
            <header>
                <div class="back-button" onclick="showPage('page4')">&#8592;</div>
                <h1>Review Your Consent</h1>
                <div class="progress-indicator">Step 5 of 7</div>
            </header>
            <div class="progress-bar">
                <div class="progress" id="progressBar" style="width: 70%;"></div>
            </div>
            <main>
                <p>Please review your selections before confirming. You can edit any section by clicking "Edit".</p>
                <div id="reviewSection">
                    <!-- Review details will be dynamically loaded here -->
                </div>
                <button class="btn" onclick="proceedFromPage5()">Confirm and Proceed</button>
            </main>
        </div>

        <!-- Page 6: Consent Confirmation and Legal Disclosures -->
        <div id="page6" class="content-section hidden">
            <header>
                <div class="back-button" onclick="showPage('page5')">&#8592;</div>
                <h1>Consent Confirmation</h1>
                <div class="progress-indicator">Step 6 of 7</div>
            </header>
            <div class="progress-bar">
                <div class="progress" id="progressBar" style="width: 84%;"></div>
            </div>
            <main>
                <p>Please read the following legal disclosures carefully:</p>
                <div class="legal-section" id="legalDisclosures">
                    <!-- Legal disclosures will be dynamically loaded here -->
                </div>
                <label>
                    <input type="checkbox" id="agreeTerms"> I have read and agree to the terms and conditions.
                </label>
                <button class="btn" onclick="proceedFromPage6()">Confirm Consent</button>
            </main>
        </div>

        <!-- Page 7: Confirmation of Consent -->
        <div id="page7" class="content-section hidden">
            <header>
                <h1>Consent Recorded</h1>
                <div class="progress-indicator">Step 7 of 7</div>
            </header>
            <div class="progress-bar">
                <div class="progress" id="progressBar" style="width: 100%;"></div>
            </div>
            <main class="confirmation">
                <div class="icon">&#10004;</div>
                <p>Your consent has been successfully recorded.</p>
                <p>You can download a copy of your consent agreement below:</p>
                <button class="btn" onclick="downloadConsent()">Download Consent Agreement</button>
                <button class="btn" onclick="finishProcess()">Finish</button>
            </main>
        </div>

    </div>

    <!-- JavaScript -->
    <script>
        let interactionLog = [];
        let currentState = {
            page: 'page1',
            selectedBanks: [],
            selectedAccounts: {},
            selectedCategories: [],
            selectedFunctions: {},
            selectedDuration: '',
            customStartDate: '',
            customEndDate: '',
            agreedToTerms: false
        };

        const categories = [
        {
            id: 'personal-info',
            text: 'Personal Information',
            description: `
            <strong>TL;DR:</strong> Personal identifiers crucial for financial transactions and compliance, secured with advanced privacy technology.<br>
            <ul>
                <li>Includes key identifiers like PAN, bank account numbers, and account types.</li>
                <li>Essential for transactions, regulatory compliance (AML, KYC).</li>
                <li>Handled with high security, including ZKP for purpose-specific compliance.</li>
            </ul>
            `,
            functions: [
            { id: 'pan-number', text: 'Permanent Account Number of the user', description: `
                <strong>TL;DR:</strong> PAN is crucial for financial legality; shared securely via ZKP to respect user consent.<br>
                <ul>
                <li>Unique ten-digit alphanumeric identifier for tax-related and financial transactions.</li>
                <li>Vital for government tracking of financial activities and tax evasion prevention.</li>
                <li>ZKP ensures PAN is shared only for consented purposes.</li>
                </ul>
            ` },
            { id: 'bank-account-number', text: 'Bank account number of the user', description: `
                <strong>TL;DR:</strong> Bank account numbers facilitate secure and precise financial transactions, protected by ZKP.<br>
                <ul>
                <li>Unique identifier for processing checks and electronic transfers.</li>
                <li>Integral for accurate transaction execution and routing between banks.</li>
                <li>ZKP used to ensure consent-specific data sharing.</li>
                </ul>
            ` },
            { id: 'bank-account-type', text: 'Bank account type of the user', description: `
                <strong>TL;DR:</strong> Account type affects financial terms and compliance, securely shared as per user consent.<br>
                <ul>
                <li>Identifies account type—savings, checking, etc.—affecting transaction terms.</li>
                <li>Important for financial management and regulatory compliance.</li>
                <li>Data shared according to specific user permissions via ZKP.</li>
                </ul>
            ` },
            ]
        },
        {
            id: 'account-balances',
            text: 'Account Balances',
            description: `
            <strong>TL;DR:</strong> Account balance data, crucial for personal financial oversight, is shared with strict privacy controls.<br>
            <ul>
                <li>Tracks financial asset states in user accounts over time.</li>
                <li>Key for financial management, loan assessments, and planning.</li>
                <li>Utilizes ZKP to maintain privacy and ensure minimum data disclosure.</li>
            </ul>
            `,
            functions: [
            { id: 'latest-account-value', text: 'Amount value of the account as of the latest date', description: `
                <strong>TL;DR:</strong> Latest account balance provides immediate financial status, securely shared for authorized purposes only.<br>
                <ul>
                <li>Provides the most recent snapshot of user's available funds.</li>
                <li>Crucial for assessing short-term financial readiness and stability.</li>
                <li>ZKP ensures data is shared only under specific consents.</li>
                </ul>
            ` },
            { id: 'end-of-month-balances', text: 'Balances as on the end of the month', description: `
                <strong>TL;DR:</strong> End-of-month balances highlight financial trends and are shared under strict consent protocols.<br>
                <ul>
                <li>Calculates monthly closing balances, showing financial trends and savings behavior.</li>
                <li>Supports long-term financial planning and budgeting.</li>
                <li>Data shared securely adhering to user permissions via ZKP.</li>
                </ul>
            ` },
            { id: 'daily-balances', text: 'End of day balances for every day of the month', description: `
                <strong>TL;DR:</strong> Daily account balances offer detailed financial tracking, shared with rigorous privacy measures.<br>
                <ul>
                <li>Tracks daily financial fluctuations, aiding in detailed financial monitoring.</li>
                <li>Useful for detecting unusual account activities potentially indicating fraud.</li>
                <li>ZKP ensures privacy-preserving sharing aligned with user consent.</li>
                </ul>
            ` },
            ]
        },
        {
            id: 'transaction-summary',
            text: 'Transaction Summary',
            description: `
            <strong>TL;DR:</strong> Transaction summaries offer insights into financial habits and are securely shared following strict consent rules.<br>
            <ul>
                <li>Summarizes credit and debit activities, providing a comprehensive overview of financial operations.</li>
                <li>Supports anomaly detection, financial advice, and budget management.</li>
                <li>Each summary is shared strictly under the terms agreed by the user, enhanced by ZKP.</li>
            </ul>
            `,
            functions: [
            { id: 'total-credited', text: "Total amount credited to the user's account", description: `
                <strong>TL;DR:</strong> Total credits show income levels and are shared only for agreed purposes, safeguarded by advanced privacy tech.<br>
                <ul>
                <li>Calculates all credit entries, reflecting total income and transfers into the account.</li>
                <li>Essential for financial assessments and income verification.</li>
                <li>ZKP ensures that data sharing respects user-defined boundaries.</li>
                </ul>
            ` },
            { id: 'total-debited', text: "Total amount debited from the user's account", description: `
                <strong>TL;DR:</strong> Total debits provide expenditure insights, shared securely based on user consent.<br>
                <ul>
                <li>Aggregates all debits, showing total expenditures and outflows.</li>
                <li>Important for budget management and fraud detection.</li>
                <li>Shared securely according to specific consents, using ZKP.</li>
                </ul>
            ` },
            { id: 'average-salary', text: 'The 6 month average salary of the user', description: `
                <strong>TL;DR:</strong> Average salary calculated to aid in financial assessments, securely shared respecting user privacy.<br>
                <ul>
                <li>Calculates the stable monthly income over six months, aiding in financial stability assessments.</li>
                <li>Used by lenders and advisors for informed decision-making regarding loans and financial advice.</li>
                <li>ZKP ensures salary data is shared only as authorized by the user.</li>
                </ul>
            ` },
            { id: 'cash-deposit-ratio', text: 'The monthly cash deposit to total credit amount ratio', description: `
                <strong>TL;DR:</strong> Cash deposit ratio helps understand financial liquidity, shared only per user consent.<br>
                <ul>
                <li>Compares monthly cash deposits against total credits, indicating liquidity and cash reliance.</li>
                <li>Crucial for analyzing financial behaviors and product suitability.</li>
                <li>Shared with ZKP to ensure compliance with specific user permissions.</li>
                </ul>
            ` },
            { id: 'outward-cheque-bounces', text: 'Total number of outward cheque bounces', description: `
                <strong>TL;DR:</strong> Cheque bounce counts are critical for financial health monitoring, shared under strict privacy protocols.<br>
                <ul>
                <li>Counts cheque bounces due to insufficient funds, indicating potential financial management issues.</li>
                <li>Essential for maintaining account compliance and integrity.</li>
                <li>ZKP applied to ensure data is shared strictly under user-consented terms.</li>
                </ul>
            ` },
            ]
        },
        {
            id: 'expense-analysis',
            text: 'Expense Analysis',
            description: `
            <strong>TL;DR:</strong> Expense analysis categorizes spending for better financial management, shared with strict adherence to privacy.<br>
            <ul>
                <li>Breaks down and categorizes expenditures into types like groceries, utilities, and more.</li>
                <li>Key for personal budgeting and identifying savings opportunities.</li>
                <li>Securely shared following stringent privacy standards and user consent via ZKP.</li>
            </ul>
            `,
            functions: [
            { id: 'expense-classification', text: "Detailed classification of the user's monthly expenses", description: `
                <strong>TL;DR:</strong> Detailed expense classification aids in budget optimization, shared respecting user privacy conditions.<br>
                <ul>
                <li>Categorizes each expense transaction to aid in detailed budgeting and financial planning.</li>
                <li>Helps optimize spending and supports targeted financial advising.</li>
                <li>Data shared under strict privacy controls enabled by ZKP.</li>
                </ul>
            ` },
            ]
        },
        {
            id: 'financial-ratios',
            text: 'Financial Ratios',
            description: `
            <strong>TL;DR:</strong> Financial ratios analyze economic stability and are shared following strict privacy agreements.<br>
            <ul>
                <li>Provides critical metrics on financial health using data like income, debts, and expenses.</li>
                <li>Used for credit assessments and financial advising.</li>
                <li>Financial ratios are shared only as per user agreement, secured with ZKP.</li>
            </ul>
            `,
            functions: [
            { id: 'foir', text: 'Financial Obligation Ratio (FOIR)', description: `
                <strong>TL;DR:</strong> FOIR measures debt-to-income ratio crucial for financial assessments, shared with ensured privacy.<br>
                <ul>
                <li>Calculates income percentage dedicated to debt repayments, aiding in loan eligibility assessments.</li>
                <li>Key for lenders to evaluate financial health and risk.</li>
                <li>ZKP ensures FOIR data is shared strictly for agreed purposes.</li>
                </ul>
            ` },
            { id: 'betting-cash-flags', text: 'Betting and Cash Withdrawal Flags', description: `
                <strong>TL;DR:</strong> High-risk financial activity flags maintain account safety, shared only under specific consent.<br>
                <ul>
                <li>Identifies high-risk transactions like frequent betting or large cash withdrawals.</li>
                <li>Important for monitoring potential fraud and maintaining account security.</li>
                <li>Data shared strictly within user-set boundaries, protected by ZKP.</li>
                </ul>
            ` },
            ]
        },
        ];

        function logInteraction(action, details = {}) {
            const timestamp = new Date().toISOString();
            const logEntry = { timestamp, action, ...details, currentState: { ...currentState } };
            interactionLog.push(logEntry);
            console.log('Interaction logged:', logEntry);
        }

        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.content-section').forEach(page => {
                page.classList.add('hidden');
            });
            // Show the requested page
            document.getElementById(pageId).classList.remove('hidden');
            currentState.page = pageId;
            logInteraction('Page Navigation', { toPage: pageId });
            updateProgressBar(pageId);
            if (pageId === 'page2') loadBankOptions();
            if (pageId === 'page3') loadCategoryOptions();
            if (pageId === 'page5') loadReview();
            if (pageId === 'page6') loadLegalDisclosures();
        }

        function updateProgressBar(pageId) {
            const progressBar = document.querySelector('.progress');
            let width = 0;
            switch (pageId) {
                case 'page1': width = 14; break;
                case 'page2': width = 28; break;
                case 'page3': width = 42; break;
                case 'page4': width = 56; break;
                case 'page5': width = 70; break;
                case 'page6': width = 84; break;
                case 'page7': width = 100; break;
                default: width = 0;
            }
            progressBar.style.width = width + '%';
            updateProgressIndicator(pageId);
        }

        function updateProgressIndicator(pageId) {
            const stepNumber = {
                'page1': 'Step 1 of 7',
                'page2': 'Step 2 of 7',
                'page3': 'Step 3 of 7',
                'page4': 'Step 4 of 7',
                'page5': 'Step 5 of 7',
                'page6': 'Step 6 of 7',
                'page7': 'Step 7 of 7'
            };
            document.querySelector(`#${pageId} .progress-indicator`).textContent = stepNumber[pageId];
        }

        function loadBankOptions() {
            const banks = ['Bank A', 'Bank B', 'Bank C', 'Bank D', 'Bank E'];
            const bankList = document.getElementById('bankList');
            bankList.innerHTML = '';
            banks.forEach(bank => {
                const li = document.createElement('li');
                li.classList.add('option-item');
                li.onclick = function() { toggleBankSelection(this, bank); };
                li.innerHTML = `<input type="checkbox" value="${bank}"> <span class="details">${bank}</span>`;
                bankList.appendChild(li);
            });
        }

        function toggleBankSelection(element, bank) {
            const checkbox = element.querySelector('input');
            checkbox.checked = !checkbox.checked;
            element.classList.toggle('active', checkbox.checked);
            if (checkbox.checked) {
                currentState.selectedBanks.push(bank);
                currentState.selectedAccounts[bank] = [];
                // Simulate account selection
                selectAccountsForBank(bank);
            } else {
                currentState.selectedBanks = currentState.selectedBanks.filter(item => item !== bank);
                delete currentState.selectedAccounts[bank];
            }
            logInteraction('Bank Selection Toggled', { bank, selected: checkbox.checked });
        }

        function selectAccountsForBank(bank) {
            // Simulate account selection for the bank
            const accounts = ['Savings Account', 'Checking Account', 'Credit Card'];
            currentState.selectedAccounts[bank] = accounts;
            logInteraction('Accounts Selected for Bank', { bank, accounts });
        }

        function loadCategoryOptions() {
            const categoryList = document.getElementById('categoryList');
            categoryList.innerHTML = '';
            categories.forEach(category => {
                const categoryItem = document.createElement('div');
                categoryItem.classList.add('option-item');
                categoryItem.onclick = function() { toggleCategorySelection(this, category.id); };
                categoryItem.innerHTML = `
                    <div class="category-header">
                        <input type="checkbox" value="${category.id}"> <span class="details">${category.text}</span>
                        <div class="read-more" onclick="toggleReadMore(this, event)">Read More</div>
                        <div class="read-more-content">${category.description}</div>
                    </div>
                    <div class="sub-options" id="subOptions-${category.id}">
                        <!-- Sub-options will be loaded here -->
                    </div>
                `;
                categoryList.appendChild(categoryItem);
            });
        }

        function toggleCategorySelection(element, categoryId) {
            const checkbox = element.querySelector('.category-header input');
            checkbox.checked = !checkbox.checked;
            element.classList.toggle('active', checkbox.checked);

            const subOptionsDiv = element.querySelector('.sub-options');
            if (checkbox.checked) {
                currentState.selectedCategories.push(categoryId);
                currentState.selectedFunctions[categoryId] = [];
                loadSubOptions(categoryId, subOptionsDiv);
            } else {
                currentState.selectedCategories = currentState.selectedCategories.filter(id => id !== categoryId);
                delete currentState.selectedFunctions[categoryId];
                subOptionsDiv.innerHTML = '';
            }
            logInteraction('Category Selection Toggled', { categoryId, selected: checkbox.checked });
        }

        function loadSubOptions(categoryId, subOptionsDiv) {
            const category = categories.find(cat => cat.id === categoryId);
            subOptionsDiv.innerHTML = '';
            category.functions.forEach(func => {
                const subOptionItem = document.createElement('div');
                subOptionItem.classList.add('sub-option-item');
                subOptionItem.onclick = function(event) { toggleFunctionSelection(this, categoryId, func.id, event); };
                subOptionItem.innerHTML = `
                    <input type="checkbox" value="${func.id}"> <span>${func.text}</span>
                    <div class="read-more" onclick="toggleReadMore(this, event)">Read More</div>
                    <div class="read-more-content">${func.description}</div>
                `;
                subOptionsDiv.appendChild(subOptionItem);
            });
        }

        function toggleFunctionSelection(element, categoryId, functionId, event) {
            event.stopPropagation();
            const checkbox = element.querySelector('input');
            checkbox.checked = !checkbox.checked;
            if (checkbox.checked) {
                currentState.selectedFunctions[categoryId].push(functionId);
            } else {
                currentState.selectedFunctions[categoryId] = currentState.selectedFunctions[categoryId].filter(id => id !== functionId);
            }
            logInteraction('Function Selection Toggled', { categoryId, functionId, selected: checkbox.checked });
        }

        function selectDuration(element, value) {
            document.querySelectorAll('[name="duration"]').forEach(radio => {
                radio.checked = false;
                radio.parentElement.classList.remove('active');
            });
            const radio = element.querySelector('input');
            radio.checked = true;
            element.classList.add('active');
            currentState.selectedDuration = value;
            logInteraction('Duration Selected', { duration: value });
            if (value === 'custom') {
                document.getElementById('customDuration').classList.remove('hidden');
            } else {
                document.getElementById('customDuration').classList.add('hidden');
                currentState.customStartDate = '';
                currentState.customEndDate = '';
            }
        }

        function toggleAdvancedDuration() {
            selectDuration(document.querySelector('[value="custom"]').parentElement, 'custom');
        }

        function proceedFromPage2() {
            if (currentState.selectedBanks.length === 0) {
                alert('Please select at least one bank.');
                return;
            }
            showPage('page3');
        }

        function proceedFromPage3() {
            const errorDiv = document.getElementById('page3Error');
            let valid = true;
            if (currentState.selectedCategories.length === 0) {
                valid = false;
            } else {
                currentState.selectedCategories.forEach(categoryId => {
                    if (!currentState.selectedFunctions[categoryId] || currentState.selectedFunctions[categoryId].length === 0) {
                        valid = false;
                    }
                });
            }
            if (!valid) {
                errorDiv.style.display = 'block';
                return;
            } else {
                errorDiv.style.display = 'none';
            }
            showPage('page4');
        }

        function proceedFromPage4() {
            if (currentState.selectedDuration === '') {
                alert('Please select a duration.');
                return;
            }
            if (currentState.selectedDuration === 'custom') {
                currentState.customStartDate = document.getElementById('startDate').value;
                currentState.customEndDate = document.getElementById('endDate').value;
                if (!currentState.customStartDate || !currentState.customEndDate) {
                    alert('Please select start and end dates.');
                    return;
                }
            }
            showPage('page5');
        }

        function loadReview() {
            const reviewSection = document.getElementById('reviewSection');
            let banksHtml = '';
            currentState.selectedBanks.forEach(bank => {
                banksHtml += `<p>${bank}: ${currentState.selectedAccounts[bank].join(', ')}</p>`;
            });

            let categoriesHtml = '';
            currentState.selectedCategories.forEach(categoryId => {
                const category = categories.find(c => c.id === categoryId);
                const functionsList = currentState.selectedFunctions[categoryId];
                const functionsText = functionsList.map(funcId => {
                    const func = category.functions.find(f => f.id === funcId);
                    return func ? func.text : funcId;
                }).join(', ');
                categoriesHtml += `<p><strong>${category.text}:</strong> ${functionsText}</p>`;
            });

            reviewSection.innerHTML = `
                <h3>Banks and Accounts Selected:</h3>
                ${banksHtml}
                <button class="btn" onclick="showPage('page2')">Edit</button>
                <h3>Categories and Functions:</h3>
                ${categoriesHtml}
                <button class="btn" onclick="showPage('page3')">Edit</button>
                <h3>Duration:</h3>
                <p>${currentState.selectedDuration === 'custom' ? 
                    `From ${currentState.customStartDate} to ${currentState.customEndDate}` : 
                    currentState.selectedDuration.replace('-', ' ')}</p>
                <button class="btn" onclick="showPage('page4')">Edit</button>
            `;
        }

        function proceedFromPage5() {
            showPage('page6');
        }

        function loadLegalDisclosures() {
            const legalDisclosures = document.getElementById('legalDisclosures');
            legalDisclosures.innerHTML = `
                <p><strong>Data Usage:</strong> Your data will be used solely for the purposes you've selected.</p>
                <p><strong>Data Protection:</strong> We employ industry-standard security measures to protect your data.</p>
                <p><strong>Your Rights:</strong> You have the right to revoke consent at any time.</p>
                <div class="read-more" onclick="toggleReadMoreContent(this)">View Full Terms and Conditions</div>
                <div class="read-more-content">
                    <p>Full legal terms and conditions go here, providing detailed information on data usage, protection, and user rights.</p>
                </div>
            `;
        }

        function proceedFromPage6() {
            const agreed = document.getElementById('agreeTerms').checked;
            if (!agreed) {
                alert('You must agree to the terms and conditions to proceed.');
                return;
            }
            currentState.agreedToTerms = true;
            showPage('page7');
            logInteraction('Consent Confirmed', { agreedToTerms: true });
            sendFinalLog(); // Log interactions after consent is confirmed
        }

        function downloadConsent() {
            const consentData = {
                banks: currentState.selectedBanks,
                accounts: currentState.selectedAccounts,
                categories: currentState.selectedCategories,
                functions: currentState.selectedFunctions,
                duration: currentState.selectedDuration,
                customStartDate: currentState.customStartDate,
                customEndDate: currentState.customEndDate,
                timestamp: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(consentData, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'consent_agreement.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            logInteraction('Consent Downloaded', { consentData });
        }

        function finishProcess() {
            alert('Thank you for using SecureBank services!');
            resetForms();
            showPage('page1');
        }

        function resetForms() {
            // Reset all states
            currentState = {
                page: 'page1',
                selectedBanks: [],
                selectedAccounts: {},
                selectedCategories: [],
                selectedFunctions: {},
                selectedDuration: '',
                customStartDate: '',
                customEndDate: '',
                agreedToTerms: false
            };
            document.getElementById('agreeTerms').checked = false;
            logInteraction('Forms Reset');
        }

        function toggleReadMore(element, event) {
            event.stopPropagation();
            const content = element.nextElementSibling;
            content.style.display = content.style.display === 'block' ? 'none' : 'block';
            logInteraction('Read More Toggled', { content: content.textContent, visible: content.style.display === 'block' });
        }

        function toggleReadMoreContent(element) {
            const content = element.nextElementSibling;
            content.style.display = content.style.display === 'block' ? 'none' : 'block';
            logInteraction('Read More Content Toggled', { content: content.textContent, visible: content.style.display === 'block' });
        }

        // Initialize the application
        window.addEventListener('load', () => {
            logInteraction('Page Load');
            showPage('page1');
        });

        // Before unload event to log the interaction
        window.addEventListener('beforeunload', (event) => {
            logInteraction('Page Unload');
            sendFinalLog();
        });

        function sendFinalLog() {
            const finalLog = {
                interactionLog: interactionLog,
                finalState: currentState
            };

            // Create a Blob with the JSON data
            const blob = new Blob([JSON.stringify(finalLog, null, 2)], { type: 'application/json' });

            // Create a link element and trigger the download
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'interaction_log.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            console.log('Final log downloaded:', finalLog);
        }
    </script>
</body>
</html>
